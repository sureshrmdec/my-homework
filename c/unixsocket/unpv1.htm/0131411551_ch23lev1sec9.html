<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="23.9 Heartbeating and Address Failure"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch23lev1sec8.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch23lev1sec10.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch23lev1sec9"></A>
<H3 class="docSection1Title" id="225793-919">23.9 Heartbeating and Address Failure</H3>
<P class="docText">SCTP provides a heartbeat mechanism similar in concept to TCP's keep-alive option. In the case of SCTP, however, the option is enabled by default. The application can control the heartbeat and set the error threshold for an address by using the same socket option we saw in <A class="docLink" HREF="0131411551_ch23lev1sec8.html#ch23lev1sec8">Section 23.8</A>. The error threshold is the number of missed heartbeats or retransmission timeouts that must occur before a destination address is considered unreachable. When the destination address becomes reachable again, detected by heartbeats, the address becomes active.</P>
<P class="docText">The application can disable heartbeats, but without heartbeats, SCTP has no way to detect if a failed peer address has become reachable again. Such addresses cannot come back to an active state without user intervention.</P>
<P class="docText">The heartbeat parameter field of the <TT>sctp_paddrparams</TT> structure is <TT>spp_hbinterval</TT>. If an application sets the <TT>spp_hbinterval</TT> field to <TT>SCTP_NO_HB</TT> (<TT>0</TT>), heartbeats are disabled. A value of <TT>SCTP_ISSUE_HB</TT> (<TT>0xffffffff</TT>) requests an on-demand (immediate) heartbeat. Any other value sets the heartbeat delay in milliseconds. The heartbeat delay provides a set delay between heartbeats. This value, added to the current retransmission timer value plus a random jitter, will become the amount of time between heartbeats. In <A class="docLink" HREF="#ch23fig14">Figure 23.14</A> we show a small function that will either set the heartbeat delay, request an on-demand heartbeat, or disable the heartbeat for the specified destination. Note that by leaving the retransmissions parameter, the <TT>spp_pathmaxrxt</TT> field of the <TT>sctp_paddrparams</TT> structure, set to 0, we leave the current value unchanged.</P>

<H5 class="docExampleTitle"><A NAME="ch23fig14"></A>Figure 23.14 Heartbeat control utility function.</H5>
<P class="docText"><span class="docEmphasis">sctp/sctp_modify_hb.c</span></P>

<PRE>
 1 #include    "unp.h"

 2 int
 3 heartbeat_action(int sock_fd, struct sockaddr *sa, socklen_t salen,
 4                  u_int value)
 5 {
 6     struct sctp_paddrparams sp;
 7     int     siz;

 8     bzero(&amp;sp, sizeof(sp));
 9     sp.spp_hbinterval = value;
10     memcpy((caddr_t) &amp; sp.spp_address, sa, salen);
11     Setsockopt(sock_fd, IPPROTO_SCTP,
12                SCTP_PEER_ADDR_PARAMS, &amp;sp, sizeof(sp));
13     return (0);
14 }
</PRE>

<A NAME="ch23lev3sec45"></A>
<H4 class="docSection2Title"> Zero <TT>sctp_paddrparams</TT> struct and copy interval</H4>
<p class="docText"><span class="docEmphasis"><TT>8–9</TT></span> We zero out <TT>struct sctp_paddrparams</TT> to ensure that we won't change any parameters we don't want to. We then copy the user's desired heartbeat value: <TT>SCTP_ISSUE_HB</TT>, <TT>SCTP_NO_HB</TT>, or a heartbeat interval.</p>

<A NAME="ch23lev3sec46"></A>
<H4 class="docSection2Title"> Set up address</H4>
<p class="docText"><span class="docEmphasis"><TT>10</TT></span> The function sets up the address and copies it into the <TT>sctp_paddrparams</TT> structure so that the SCTP implementation will know the address to which we wish to send a heartbeat.</p>

<A NAME="ch23lev3sec47"></A>
<H4 class="docSection2Title"> Perform action</H4>
<p class="docText"><span class="docEmphasis"><TT>11–12</TT></span> Finally, the function issues the socket option call to cause the action the user has requested.</p>


<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch23lev1sec8.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch23lev1sec10.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
