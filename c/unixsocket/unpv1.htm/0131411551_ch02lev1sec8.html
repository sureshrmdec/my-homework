<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="2.8 SCTP Association Establishment and Termination"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch02lev1sec7.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch02lev1sec9.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch02lev1sec8"></A>
<H3 class="docSection1Title">2.8 SCTP Association Establishment and Termination</H3>
<P class="docText">SCTP is connection-oriented like TCP, so it also has association establishment and termination handshakes. However, SCTP's handshakes are different than TCP's, so we describe them here.</P>
<A NAME="ch02lev2sec6"></A>
<H4 class="docSection2Title"> Four-Way Handshake</H4>
<P class="docText">The following scenario, similar to TCP, occurs when an SCTP association is established:</P>
<A NAME="ch02pro03"></A>





<span style="font-weight:bold"><OL class="docList" START="1"><LI><span style="font-weight:normal" value="1"><P class="docText">The server must be prepared to accept an incoming association. This preparation is normally done by calling <TT>socket</TT>, <TT>bind</TT>, and <TT>listen</TT> and is called a <span class="docEmphasis">passive open</span>.</P>
</span></LI><LI><span style="font-weight:normal" value="2"><P class="docText">The client issues an <span class="docEmphasis">active open</span> by calling <TT>connect</TT> or by sending a message, which implicitly opens the association. This causes the client SCTP to send an INIT message (which stands for "initialization") to tell the server the client's list of IP addresses, initial sequence number, initiation tag to identify all packets in this association, number of outbound streams the client is requesting, and number of inbound streams the client can support.</P>
</span></LI><LI><span style="font-weight:normal" value="3"><P class="docText">The server acknowledges the client's INIT message with an INIT-ACK message, which contains the server's list of IP addresses, initial sequence number, initiation tag, number of outbound streams the server is requesting, number of inbound streams the server can support, and a state cookie. The state cookie contains all of the state that the server needs to ensure that the association is valid, and is digitally signed to ensure its validity.</P>
</span></LI><LI><span style="font-weight:normal" value="4"><P class="docText">The client echos the server's state cookie with a COOKIE-ECHO message. This message may also contain user data bundled within the same packet.</P>
</span></LI><LI><span style="font-weight:normal" value="5"><P class="docText">The server acknowledges that the cookie was correct and that the association was established with a COOKIE-ACK message. This message may also contain user data bundled within the same packet.</P>
</span></LI></OL></span>
<P class="docText">The minimum number of packets required for this exchange is four; hence, this process is called SCTP's <span class="docEmphasis">four-way handshake</span>. We show a picture of the four segments in <A class="docLink" HREF="#ch02fig06">Figure 2.6</A>.</P>
<CENTER>
<H5 class="docFigureTitle"><A NAME="ch02fig06"></A>Figure 2.6. SCTP four-way handshake.</H5>

<p class="docText">
<IMG BORDER="0" WIDTH="500" HEIGHT="211" src="FILES/02fig06.gif" ALT="graphics/02fig06.gif"></p>

</CENTER>
<P class="docText">The SCTP four-way handshake is similar in many ways to TCP's three-way handshake, except for the cookie generation, which is an integral part. The INIT carries with it (along with its many parameters) a verification tag, <span class="docEmphasis">Ta</span>, and an initial sequence number, <span class="docEmphasis">J</span>. The tag <span class="docEmphasis">Ta</span> must be present in every packet sent by the peer for the life of the association. The initial sequence number <span class="docEmphasis">J</span> is used as the starting sequence number for DATA messages termed DATA chunks. The peer also chooses a verification tag, <span class="docEmphasis">Tz</span>, which must be present in each of its packets for the life of the association. Along with the verification tag and initial sequence number, <span class="docEmphasis">K</span>, the receiver of the INIT also sends a cookie, <span class="docEmphasis">C</span>. The cookie contains all the state needed to set up the SCTP association, so that the server's SCTP stack does not need to keep information about the associating client. Further details on SCTP's association setup can be found in Chapter 4 of [Stewart and Xie 2001].</P>
<P class="docText">At the conclusion of the four-way handshake, each side chooses a primary destination address. The primary destination address is used as the default destination to which data will be sent in the absence of network failure.</P>
<P class="docText">The four-way handshake is used in SCTP to avoid a form of denial-of-service attack we will discuss in <A class="docLink" HREF="0131411551_ch04lev1sec5.html#ch04lev1sec5">Section 4.5</A>.</P>
<BLOCKQUOTE><P><P class="docList">SCTP's four-way handshake using Cookies formalizes a method of protection against this attack. Many TCP implementations use a similar method; the big difference is that in TCP, the cookie state must be encoded into the initial sequence number, which is only 32 bits. SCTP provides an arbitrary-length field, and requires cryptographic security to prevent attacks.</P></P></BLOCKQUOTE>

<A NAME="ch02lev2sec7"></A>
<H4 class="docSection2Title"> Association Termination</H4>
<P class="docText">Unlike TCP, SCTP does not permit a "half-closed" association. When one end shuts down an association, the other end must stop sending new data. The receiver of the shutdown request sends the data that was queued, if any, and then completes the shutdown. We show this exchange in <A class="docLink" HREF="#ch02fig07">Figure 2.7</A>.</P>
<CENTER>
<H5 class="docFigureTitle"><A NAME="ch02fig07"></A>Figure 2.7. Packets exchanged when an SCTP association is closed.</H5>

<p class="docText">
<IMG BORDER="0" WIDTH="441" HEIGHT="196" src="FILES/02fig07.gif" ALT="graphics/02fig07.gif"></p>

</CENTER>
<P class="docText">SCTP does not have a TIME_WAIT state like TCP, due to its use of verification tags. All chunks are tagged with the tag exchanged in the INIT chunks; a chunk from an old connection will arrive with an incorrect tag. Therefore, in lieu of keeping an entire connection in TIME_WAIT, SCTP instead places verification tag values in TIME_WAIT.</P>

<A NAME="ch02lev2sec8"></A>
<H4 class="docSection2Title"> SCTP State Transition Diagram</H4>
<P class="docText">The operation of SCTP with regard to association establishment and termination can be specified with a <span class="docEmphasis">state transition diagram</span>. We show this in <A class="docLink" HREF="#ch02fig08">Figure 2.8</A>.</P>
<CENTER>
<H5 class="docFigureTitle"><A NAME="ch02fig08"></A>Figure 2.8. SCTP state transition diagram.</H5>

<p class="docText">
<IMG BORDER="0" WIDTH="500" HEIGHT="605" src="FILES/02fig08.gif" ALT="graphics/02fig08.gif"></p>

</CENTER>
<P class="docText">As in <A class="docLink" HREF="0131411551_ch02lev1sec6.html#ch02fig04">Figure 2.4</A>, the transitions from one state to another in the state machine are dictated by the rules of SCTP, based on the current state and the chunk received in that state. For example, if an application performs an active open in the CLOSED state, SCTP sends an INIT and the new state is COOKIE-WAIT. If SCTP next receives an INIT ACK, it sends a COOKIE ECHO and the new state is COOKIE-ECHOED. If SCTP then receives a COOKIE ACK, it moves to the ESTABLISHED state. This final state is where most data transfer occurs, although DATA chunks can be piggybacked on COOKIE ECHO and COOKIE ACK chunks.</P>
<P class="docText">The two arrows leading from the ESTABLISHED state deal with the termination of an association. If an application calls <TT>close</TT> before receiving a SHUTDOWN (an active close), the transition is to the SHUTDOWN-PENDING state. However, if an application receives a SHUTDOWN while in the ESTABLISHED state (a passive close), the transition is to the SHUTDOWN-RECEIVED state.</P>

<A NAME="ch02lev2sec9"></A>
<H4 class="docSection2Title"> Watching the Packets</H4>
<P class="docText"><A class="docLink" HREF="#ch02fig09">Figure 2.9</A> shows the actual packet exchange that takes place for a sample SCTP association: the association establishment, data transfer, and association termination. We also show the SCTP states through which each endpoint passes.</P>
<CENTER>
<H5 class="docFigureTitle"><A NAME="ch02fig09"></A>Figure 2.9. Packet exchange for SCTP association.</H5>

<p class="docText">
<IMG BORDER="0" WIDTH="500" HEIGHT="403" src="FILES/02fig09.gif" ALT="graphics/02fig09.gif"></p>

</CENTER>
<P class="docText">In this example, the client piggybacks its first data chunk on the COOKIE ECHO, and the server replies with data on the COOKIE ACK. In general, the COOKIE ECHO will often have one or more DATA chunks bundled with it when the application is using the one-to-many interface style (we will discuss the one-to-one and one-to-many interface styles in <A class="docLink" HREF="0131411551_ch09lev1sec2.html#ch09lev1sec2">Section 9.2</A>).</P>
<P class="docText">The unit of information within an SCTP packet is a "chunk." A "chunk" is self-descriptive and contains a chunk type, chunk flags, and a chunk length. This approach facilitates the bundling of chunks simply by combining multiple chunks into an SCTP outbound packet (details on chunk bundling and normal data transmission procedures can be found in Chapter 5 of [Stewart and Xie 2001]).</P>

<A NAME="ch02lev2sec10"></A>
<H4 class="docSection2Title"> SCTP Options</H4>
<P class="docText">SCTP uses parameters and chunks to facilitate optional features. New features are defined by adding either of these two items, and allowing normal SCTP processing rules to report unknown parameters and unknown chunks. The upper two bits of both the parameter space and the chunk space dictate what an SCTP receiver should do with an unknown parameter or chunk (further details can be found in Section 3.1 of [Stewart and Xie 2001]).</P>
<P class="docText">Currently, two extensions for SCTP are under development:</P>
<span style="font-weight:bold"><OL class="docList" TYPE="1"><LI><span style="font-weight:normal"><P class="docList">The dynamic address extension, which allows cooperating SCTP endpoints to dynamically add and remove IP addresses from an existing association.</P></span></LI><LI><span style="font-weight:normal"><P class="docList">The partial reliability extension, which allows cooperating SCTP endpoints, under application direction, to limit the retransmission of data. When a message becomes too old to send (according to the application's direction), the message will be skipped and thus no longer sent to the peer. This means that not all data is assured of arrival at the other end of the association.</P></span></LI></OL></span>


<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch02lev1sec7.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch02lev1sec9.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
