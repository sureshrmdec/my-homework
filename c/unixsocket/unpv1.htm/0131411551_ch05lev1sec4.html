<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="5.4 TCP Echo Client: 'main' Function"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch05lev1sec3.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch05lev1sec5.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch05lev1sec4"></A>
<H3 class="docSection1Title">5.4 TCP Echo Client: <TT>main</TT> Function</H3>
<P class="docText"><A class="docLink" HREF="#ch05fig04">Figure 5.4</A> shows the TCP client <TT>main</TT> function.</P>

<H5 class="docExampleTitle"><A NAME="ch05fig03"></A>Figure 5.3 <TT>str_echo</TT> function: echoes data on a socket.</H5>
<P class="docText"><span class="docEmphasis">lib/str_echo.c</span></P>

<PRE>
 1 #include    "unp.h"

 2 void
 3 str_echo(int sockfd)
 4 {
 5     ssize_t n;
 6     char    buf[MAXLINE];

 7   again:
 8     while ( (n = read(sockfd, buf, MAXLINE)) &gt; 0)
 9         Writen(sockfd, buf, n);

10     if (n &lt; 0 &amp;&amp; errno == EINTR)
11         goto again;
12     else if (n &lt; 0)
13         err_sys("str_echo: read error");
14 }
</PRE>


<H5 class="docExampleTitle"><A NAME="ch05fig04"></A>Figure 5.4 TCP echo client.</H5>
<P class="docText"><span class="docEmphasis">tcpcliserv/tcpli01.c</span></P>

<PRE>
 1 #include    "unp.h"

 2 int
 3 main(int argc, char **argv)
 4 {
 5     int     sockfd;
 6     struct sockaddr_in servaddr;

 7     if (argc != 2)
 8         err_quit("usage: tcpcli &lt;IPaddress&gt;");

 9     sockfd = Socket(AF_INET, SOCK_STREAM, 0);

10     bzero(&amp;servaddr, sizeof(servaddr));
11     servaddr.sin_family = AF_INET;
12     servaddr.sin_port = htons(SERV_PORT);
13     Inet_pton(AF_INET, argv[1], &amp;servaddr.sin_addr);

14     Connect(sockfd, (SA *) &amp;servaddr, sizeof(servaddr));

15     str_cli(stdin, sockfd);     /* do it all */

16     exit(0);
17 }
</PRE>

<A NAME="ch05lev3sec5"></A>
<H4 class="docSection2Title"> Create socket, fill in Internet socket address structure</H4>
<p class="docText"><span class="docEmphasis"><TT>9–13</TT></span> A TCP socket is created and an Internet socket address structure is filled in with the server's IP address and port number. We take the server's IP address from the command-line argument and the server's well-known port (<TT>SERV_PORT</TT>) is from our <TT>unp.h</TT> header.</p>

<A NAME="ch05lev3sec6"></A>
<H4 class="docSection2Title"> Connect to server</H4>
<p class="docText"><span class="docEmphasis"><TT>14–15</TT></span> <TT>connect</TT> establishes the connection with the server. The function <TT>str_cli</TT> (<A class="docLink" HREF="0131411551_ch05lev1sec5.html#ch05fig05">Figure 5.5</A>) handles the rest of the client processing.</p>


<a href="0131411551_23961534.html"><img src="FILES/pixel.gif" width="1" height="1" border="0"></a><ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch05lev1sec3.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch05lev1sec5.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
