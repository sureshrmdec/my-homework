<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="4.9 'close' Function"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch04lev1sec8.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch04lev1sec10.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch04lev1sec9"></A>
<H3 class="docSection1Title">4.9 <TT>close</TT> Function</H3>
<P class="docText">The normal Unix <TT>close</TT> function is also used to close a socket and terminate a TCP connection.</P>
<P><TABLE CELLSPACING="0" BORDER="1" RULES="none" CELLPADDING="5" WIDTH="100%"><COLGROUP align="left" span="1"><THEAD></THEAD><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>#include &lt;unistd.h&gt;</TT></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>int close (int</TT> <span class="docEmphasis">sockfd</span><TT>);</TT></P></TD></TR><TR><TD class="docTableCell" align="right" valign="top"><P class="docText">Returns: 0 if OK, -1 on error</P></TD></TR></COLGROUP></TABLE></P>
<P class="docText">The default action of <TT>close</TT> with a TCP socket is to mark the socket as closed and return to the process immediately. The socket descriptor is no longer usable by the process: It cannot be used as an argument to <TT>read</TT> or <TT>write</TT>. But, TCP will try to send any data that is already queued to be sent to the other end, and after this occurs, the normal TCP connection termination sequence takes place (<A class="docLink" HREF="0131411551_ch02lev1sec6.html#ch02lev1sec6">Section 2.6</A>).</P>
<P class="docText">In <A class="docLink" HREF="0131411551_ch07lev1sec5.html#ch07lev1sec5">Section 7.5</A>, we will describe the <TT>SO_LINGER</TT> socket option, which lets us change this default action with a TCP socket. In that section, we will also describe what a TCP application must do to be guaranteed that the peer application has received any outstanding data.</P>
<A NAME="ch04lev2sec3"></A>
<H4 class="docSection2Title"> Descriptor Reference Counts</H4>
<P class="docText">At the end of <A class="docLink" HREF="0131411551_ch04lev1sec8.html#ch04lev1sec8">Section 4.8</A>, we mentioned that when the parent process in our concurrent server <TT>closes</TT> the connected socket, this just decrements the reference count for the descriptor. Since the reference count was still greater than 0, this call to <TT>close</TT> did not initiate TCP's four-packet connection termination sequence. This is the behavior we want with our concurrent server with the connected socket that is shared between the parent and child.</P>
<P class="docText">If we really want to send a FIN on a TCP connection, the <TT>shutdown</TT> function can be used (<A class="docLink" HREF="0131411551_ch06lev1sec6.html#ch06lev1sec6">Section 6.6</A>) instead of <TT>close</TT>. We will describe the motivation for this in <A class="docLink" HREF="0131411551_ch06lev1sec5.html#ch06lev1sec5">Section 6.5</A>.</P>
<P class="docText">We must also be aware of what happens in our concurrent server if the parent does not call <TT>close</TT> for each connected socket returned by <TT>accept</TT>. First, the parent will eventually run out of descriptors, as there is usually a limit to the number of descriptors that any process can have open at any time. But more importantly, none of the client connections will be terminated. When the child closes the connected socket, its reference count will go from 2 to 1 and it will remain at 1 since the parent never <TT>closes</TT> the connected socket. This will prevent TCP's connection termination sequence from occurring, and the connection will remain open.</P>


<a href="0131411551_22961534.html"><img src="FILES/pixel.gif" width="1" height="1" border="0"></a><ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch04lev1sec8.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch04lev1sec10.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
