<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="10.2 SCTP One-to-Many-Style Streaming Echo Server: 'main' Function"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch10lev1sec1.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch10lev1sec3.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch10lev1sec2"></A>
<H3 class="docSection1Title">10.2 SCTP One-to-Many-Style Streaming Echo Server: <TT>main</TT> Function</H3>
<P class="docText">Our SCTP client and server follow the flow of functions diagrammed in <A class="docLink" HREF="0131411551_ch09lev1sec2.html#ch09fig02">Figure 9.2</A>. We show an iterative server program in <A class="docLink" HREF="#ch10fig02">Figure 10.2</A>.</P>
<A NAME="ch10lev3sec1"></A>
<H4 class="docSection2Title"> Set stream increment option</H4>
<p class="docText"><span class="docEmphasis"><TT>13–14</TT></span> By default, our server responds using the next higher stream than the one on which the message was received. If an integer argument is passed on the command line, the server interprets the argument as the value of <TT>stream_increment</TT>, that is, it decides whether or not to increment the stream number of incoming messages. We will use this option in our discussion of head-of-line blocking in <A class="docLink" HREF="0131411551_ch10lev1sec5.html#ch10lev1sec5">Section 10.5</A>.</p>

<A NAME="ch10lev3sec2"></A>
<H4 class="docSection2Title"> Create an SCTP socket</H4>
<p class="docText"><span class="docEmphasis"><TT>15</TT></span> An SCTP one-to-many-style socket is created.</p>

<A NAME="ch10lev3sec3"></A>
<H4 class="docSection2Title"> Bind an address</H4>
<p class="docText"><span class="docEmphasis"><TT>16–20</TT></span> An Internet socket address structure is filled in with the wildcard address (<TT>INADDR_ANY</TT>) and the server's well-known port, <TT>SERV_PORT</TT>. Binding the wildcard address tells the system that this SCTP endpoint will use all available local addresses in any association that is set up. For multihomed hosts, this binding means that a remote endpoint will be able to make associations with and send packets to any of the local host's routeable addresses. Our choice of the SCTP port number is based on <A class="docLink" HREF="0131411551_ch02lev1sec9.html#ch02fig10">Figure 2.10</A>. Note that the server makes the same considerations that were made earlier in our previous example found in <A class="docLink" HREF="0131411551_ch05lev1sec2.html#ch05lev1sec2">Section 5.2</A>.</p>

<A NAME="ch10lev3sec4"></A>
<H4 class="docSection2Title"> Set up for notifications of interest</H4>
<p class="docText"><span class="docEmphasis"><TT>21–23</TT></span> The server changes its notification subscription for the one-to-many SCTP socket. The server subscribes to just the <TT>sctp_data_io_event</TT>, which will allow the server to see the <TT>sctp_sndrcvinfo</TT> structure. From this structure, the server can determine the stream number on which the message arrived.</p>

<A NAME="ch10lev3sec5"></A>
<H4 class="docSection2Title"> Enable incoming associations</H4>
<p class="docText"><span class="docEmphasis"><TT>24</TT></span> The server enables incoming associations with the <TT>listen</TT> call. Then, control enters the main processing loop.</p>

<H5 class="docExampleTitle"><A NAME="ch10fig02"></A>Figure 10.2 SCTP streaming echo server.</H5>
<P class="docText"><span class="docEmphasis">sctp/sctpserv01.c</span></P>

<PRE>
 1 #include     "unp.h"

 2 int
 3 main(int argc, char **argv)
 4 {
 5     int     sock_fd, msg_flags;
 6     char    readbuf [BUFFSIZE];
 7     struct sockaddr_in servaddr, cliaddr;
 8     struct sctp_sndrcvinfo sri;
 9     struct sctp_event_subscribe evnts;
10     int     stream_increment = 1;
11     socklen_t len;
12     size_t rd_sz;

13     if (argc == 2)
14         stream_increment = atoi (argv[1]);
15     sock_fd = Socket (AF_INET, SOCK_SEQPACKET, IPPROTO_SCTP);
16     bzero (&amp;servaddr, sizeof(servaddr));
17     servaddr.sin_family = AF_INET;
18     servaddr.sin_addr.s_addr = htonl (INADDR_ANY);
19     servaddr.sin_port = htons (SERV_PORT);

20     Bind (sock_fd, (SA *) &amp;servaddr, sizeof (servaddr));

21     bzero (&amp;evnts, sizeof (evnts)) ;
22     evnts.sctp_data_io_event = 1;
23     Setsockopt (sock_fd, IPPROTO_SCTP, SCTP_EVENTS, &amp;evnts, sizeof (evnts)) ;

24     Listen(sock_fd, LISTENQ) ;
25     for ( ; ; ) {
26         len = sizeof(struct sockaddr_in) ;
27         rd_sz = Sctp_recvmsg(sock_fd, readbuf, sizeof (readbuf) ,
28                               (SA *) &amp;cliaddr, &amp;len, &amp;sri, &amp;msg_flags) ;
29         if (stream_increment) {
30             sri.sinfo_stream++;
31             if (sri.sinfo_stream &gt;=
32                sctp_get_no_strms (sock_fd, (SA *) &amp;cliaddr, len) )
33                sri.sinfo_stream = 0;
34         }
35         Sctp_sendmsg (sock_fd, readbuf, rd_sz,
36                       (SA *) &amp;cliaddr, len,
37                       sri.sinfo_ppid,
38                       sri.sinfo_flags, sri.sinfo_stream, 0, 0) ;
39     }
40 }
</PRE>


<A NAME="ch10lev3sec6"></A>
<H4 class="docSection2Title"> Wait for message</H4>
<p class="docText"><span class="docEmphasis"><TT>26–28</TT></span> The server initializes the size of the client socket address structure, then blocks while waiting for a message from any remote peer.</p>

<A NAME="ch10lev3sec7"></A>
<H4 class="docSection2Title"> Increment stream number if desired</H4>
<p class="docText"><span class="docEmphasis"><TT>29–34</TT></span> When a message arrives, the server checks the <TT>stream_increment</TT> flag to see if it should increment the stream number. If the flag is set (no arguments were passed on the command line), the server increments the stream number of the message. If that number grows larger than or equal to the maximum streams, which is obtained by calling our internal function call <TT>sctp_get_no_strms</TT>, the server resets the stream to 0. The function <TT>sctp_get_no_strms</TT> is not shown. It uses the <TT>SCTP_STATUS</TT> SCTP socket option discussed in <A class="docLink" HREF="0131411551_ch07lev1sec10.html#ch07lev1sec10">Section 7.10</A> to find the number of streams negotiated.</p>

<A NAME="ch10lev3sec8"></A>
<H4 class="docSection2Title"> Send back response</H4>
<p class="docText"><span class="docEmphasis"><TT>35–38</TT></span> The server sends back the message using the payload protocol ID, flags, and the possibly modified stream number from the <TT>sri</TT> structure.</p>
<P class="docText">Notice that this server does not want association notification, so it disables all events that would pass messages up the socket buffer. The server relies on the information in the <TT>sctp_sndrcvinfo</TT> structure and the returned address found in <span class="docEmphasis">cliaddr</span> to locate the peer association and return the echo.</P>
<P class="docText">This program runs forever until the user shuts it down with an external signal.</P>


<a href="0131411551_22961534.html"><img src="FILES/pixel.gif" width="1" height="1" border="0"></a><ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch10lev1sec1.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch10lev1sec3.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
