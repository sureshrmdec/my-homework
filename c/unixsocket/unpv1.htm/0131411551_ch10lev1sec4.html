<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="10.4 SCTP Streaming Echo Client: 'str_cli' Function"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch10lev1sec3.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch10lev1sec5.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch10lev1sec4"></A>
<H3 class="docSection1Title">10.4 SCTP Streaming Echo Client: <TT>str_cli</TT> Function</H3>
<P class="docText"><A class="docLink" HREF="#ch10fig04">Figure 10.4</A> shows our SCTP default client processing function.</P>

<H5 class="docExampleTitle"><A NAME="ch10fig04"></A>Figure 10.4 SCTP sctp_strcli function.</H5>
<P class="docText"><span class="docEmphasis">sctp/sctp_strcli.c</span></P>

<PRE>
 1 #include     "unp.h"

 2 void
 3 sctpstr_cli (FILE *fp, int sock_fd, struct sockaddr *to, socklen_t tolen)
 4 {
 5     struct sockaddr_in peeraddr;
 6     struct sctp_sndrcvinfo sri;
 7     char    sendline [MAXLINE], recvline [MAXLINE];
 8     socklen_t len;
 9     int     out_sz, rd_sz;
10     int     msg_flags;

11     bzero (&amp;sri, sizeof (sri) ) ;
12     while (fgets (sendline, MAXLINE, fp) != NULL) {
13         if (sendline [0] != ' [') {
14             printf ("Error, line must be of the form '[streamnum] text '\n");
15             continue;
16         }
17         sri.sinfo_stream = strtol (&amp;sendline [1], NULL, 0);
18         out_sz = strlen (sendline);
19         Sctp_sendmsg (sock_fd, sendline, out_sz,
20                       to, tolen, 0, 0, sri.sinfo_stream, 0, 0);

21         len = sizeof (peeraddr) ;
22         rd_sz = Sctp_recvmsg (sock_fd, recvline, sizeof (recvline),
23                               (SA *) &amp;peeraddr, &amp;len, &amp;sri, &amp;msg_flags) ;
24         printf ("From str:%d seq:%d (assoc:0x%x):",
25                 sri.sinfo_stream, sri.sinfo_ssn, (u_int) sri.sinfo_assoc_id);
26         printf ("%.*s", rd_sz, recvline);
27     }
28 }
</PRE>

<A NAME="ch10lev3sec14"></A>
<H4 class="docSection2Title"> Initialize the <TT>sri</TT> structure and enter loop</H4>
<p class="docText"><span class="docEmphasis"><TT>11–12</TT></span> The client starts by clearing the <TT>sctp_sndrcvinfo</TT> structure, <TT>sri</TT>. The client then enters a loop that reads from the <TT>fp</TT> passed by our caller with a blocking call to <TT>fgets</TT>. The main program passes <TT>stdin</TT> to this function, so user input is read and processed in the loop until the terminal EOF character (Control-D) is typed by the user. This user action ends the function and causes a return to the caller.</p>

<A NAME="ch10lev3sec15"></A>
<H4 class="docSection2Title"> Validate input</H4>
<p class="docText"><span class="docEmphasis"><TT>13–16</TT></span> The client examines the user input to make sure it is of the form <TT>[#] text</TT>. If the format is invalid, the client prints an error message and re-enters the blocking call to the <TT>fgets</TT> function.</p>

<A NAME="ch10lev3sec16"></A>
<H4 class="docSection2Title"> Translate stream number</H4>
<p class="docText"><span class="docEmphasis"><TT>17</TT></span> The client translates the user requested stream found in the input into the <TT>sinfo_stream</TT> field in the <TT>sri</TT> structure.</p>

<A NAME="ch10lev3sec17"></A>
<H4 class="docSection2Title"> Send message</H4>
<p class="docText"><span class="docEmphasis"><TT>18–20</TT></span> After initializing the appropriate lengths of the address and the size of the actual user data, the client sends the message using the <TT>sctp_sendmsg</TT> function.</p>

<A NAME="ch10lev3sec18"></A>
<H4 class="docSection2Title"> Block while waiting for message</H4>
<p class="docText"><span class="docEmphasis"><TT>21–23</TT></span> The client now blocks and waits for the echoed message from the server.</p>

<A NAME="ch10lev3sec19"></A>
<H4 class="docSection2Title"> Display returned message and loop</H4>
<p class="docText"><span class="docEmphasis"><TT>24–26</TT></span> The client displays the returned message echoed to it displaying the stream number, stream sequence number, as well as the text message. After displaying the message, the client loops back to get another request from the user.</p>

<A NAME="ch10lev2sec1"></A>
<H4 class="docSection2Title"> Running the Code</H4>
<P class="docText">A user starts the SCTP echo server with no arguments on a FreeBSD machine. The client is started with just the address of our server.</P>
<P><TABLE CELLSPACING="0" FRAME="void" RULES="none" CELLPADDING="5" WIDTH="100%"><COLGROUP align="left" span="2"><THEAD></THEAD><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>freebsd4%</TT> <span class="docEmphStrong"><TT>sctpclient01 10.1.1.5</TT></span></P></TD><TD class="docTableCell" valign="top">&nbsp;</TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphStrong"><TT>[0]Hello</TT></span></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Send a message on stream 0</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>From str:1 seq:0 (assoc:0xc99e15a0) : [0]Hello</TT></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Server echoes on stream 1</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphStrong"><TT>[4]Message two</TT></span></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Send a message on stream 4</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>From str:5 seq:0 (assoc:0xc99e15a0) : [4]Message two</TT></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Server echoes on stream 5</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphStrong"><TT>[4]Message three</TT></span></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Send a second message on stream 4</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>From str:5 seq:1 (assoc:0xc99e15a0) : [4]Message three</TT></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Server echoes on stream 5</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphStrong"><TT>^D</TT></span></P></TD><TD class="docTableCell" valign="top"><P class="docText"><span class="docEmphasis">Control-D is our EOF character</span></P></TD></TR><TR><TD class="docTableCell" valign="top"><P class="docText"><TT>freebsd4%</TT></P></TD></TR></COLGROUP></TABLE></P>
<P class="docText">Notice that the client sends the message on streams 0 and 4 while our server sends the messages back on streams 1 and 5. This behavior is expected from our server with no arguments. Also notice that the stream sequence number incremented on the second message received on stream 5, as expected.</P>


<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch10lev1sec3.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch10lev1sec5.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
