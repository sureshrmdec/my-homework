<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="Chapter 22"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_app05lev1sec20.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_app05lev1sec22.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="app05lev1sec21"></A>
<H3 class="docSection1Title" id="225793-809"> Chapter 22</H3>
<P><TABLE BORDER="0" cellspacing="16" cellpadding="0"><TR valign="top"><TD align="right" class="docText"><B></B></TD><TD><P class="docText"></P></TD></TR><TR valign="top"><TD align="right" class="docText"><A NAME="ch22a01"></A><B><A class="docLink" HREF="0131411551_ch22lev1sec11.html#ch22q01">22.1</A></B></TD><TD><P class="docText"><span class="docEmphStrong">22.1</span> Recall that <TT>sock_ntop</TT> uses its own static buffer to hold the result. If we call it twice as arguments in a call to <TT>printf</TT>, the second call overwrites the result of the first call.</P></TD></TR><TR valign="top"><TD align="right" class="docText"><B></B></TD><TD><P class="docText"></P></TD></TR><TR valign="top"><TD align="right" class="docText"><A NAME="ch22a02"></A><B><A class="docLink" HREF="0131411551_ch22lev1sec11.html#ch22q02">22.2</A></B></TD><TD><P class="docText">Yes, if the reply contains 0 bytes of user data (i.e., just an <TT>hdr</TT> structure).</P></TD></TR><TR valign="top"><TD align="right" class="docText"><B></B></TD><TD><P class="docText"></P></TD></TR><TR valign="top"><TD align="right" class="docText"><A NAME="ch22a03"></A><B><A class="docLink" HREF="0131411551_ch22lev1sec11.html#ch22q03">22.3</A></B></TD><TD><P class="docText">Since <TT>select</TT> does not modify the <TT>timeval</TT> structure that specifies its time limit, you need to note the time when the first packet is sent (this is already returned in units of milliseconds by <TT>rtt_ts</TT>). If <TT>select</TT> returns with the socket being readable, note the current time, and if <TT>recvmsg</TT> is called again, calculate the new timeout for <TT>select</TT>.</P></TD></TR><TR valign="top"><TD align="right" class="docText"><B></B></TD><TD><P class="docText"></P></TD></TR><TR valign="top"><TD align="right" class="docText"><A NAME="ch22a04"></A><B><A class="docLink" HREF="0131411551_ch22lev1sec11.html#ch22q04">22.4</A></B></TD><TD><P class="docText">The common technique is to create one socket per interface address, as we did in <A class="docLink" HREF="0131411551_ch22lev1sec6.html#ch22lev1sec6">Section 22.6</A>, and send the reply from the same socket on which the request arrived.</P></TD></TR><TR valign="top"><TD align="right" class="docText"><B></B></TD><TD><P class="docText"></P></TD></TR><TR valign="top"><TD align="right" class="docText"><A NAME="ch22a05"></A><B><A class="docLink" HREF="0131411551_ch22lev1sec11.html#ch22q05">22.5</A></B></TD><TD><P class="docText">Calling <TT>getaddrinfo</TT> without a hostname argument and without the <TT>AI_PASSIVE</TT> flag set causes it to assume the local host address: 0::1 (IPv6) and 127.0.0.1 (IPv4). Recall that an IPv6 socket address structure is returned before an IPv4 socket address structure by <TT>getaddrinfo</TT>, assuming IPv6 is supported. If both protocols are supported on the host, the call to <TT>socket</TT> in <TT>udp_client</TT> will succeed with the family equal to <TT>AF_INET6</TT>.</P><P class="docText"><A class="docLink" HREF="#app05fig15">Figure E.15</A> is the protocol-independent version of this program.</P>
<H5 class="docExampleTitle"><A NAME="app05fig15"></A>Figure E.15 Protocol-independent version of program from <A class="docLink" HREF="0131411551_ch22lev1sec6.html#ch22lev1sec6">Section 22.6</A>.</H5>
<P class="docText"><span class="docEmphasis">advio/udpserv04.c</span></P>
<PRE>
 1 #include "unpifi.h"

 2 void mydg_echo(int, SA *, socklen_t);

 3 int
 4 main(int argc, char **argv)
 5 {
 6     int sockfd, family, port;
 7     const int on = 1;
 8     pid_t pid;
 9     socklen_t salen;
10     struct sockaddr *sa, *wild;
11     struct ifi_info *ifi, *ifihead;

12     if (argc == 2)
13         sockfd = Udp_client(NULL, argv[1], (void **) &amp;sa, &amp;salen);
14     else if (argc == 3)
15         sockfd = Udp_client(argv[1], argv[2], (void **) &amp;sa, &amp;salen);
16     else
17         err_quit("usage: udpserv04 [ &lt;host&gt; ] &lt;service or port&gt;");
18     family = sa-&gt;sa_family;
19     port = sock_get_port(sa, salen);
20     Close(sockfd);              /* we just want family, port, salen */

21     for (ifihead = ifi = Get_ifi_info(family, 1);
22          ifi != NULL; ifi = ifi-&gt;ifi_next) {

23             /* bind unicast address */
24         sockfd = Socket(family, SOCK_DGRAM, 0);
25         Setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, sizeof(on));

26         sock_set_port(ifi-&gt;ifi_addr, salen, port);
27         Bind(sockfd, ifi-&gt;ifi_addr, salen);
28         printf("bound %s\n", Sock_ntop(ifi-&gt;ifi_addr, salen));

29         if ( (pid = Fork()) == 0) { /* child */
30             mydg_echo(sockfd, ifi-&gt;ifi_addr, salen);
31             exit(0);            /* never executed */
32         }

33         if (ifi-&gt;ifi_flags &amp; IFF_BROADCAST) {
34                 /* try to bind broadcast address */
35             sockfd = Socket(family, SOCK_DGRAM, 0);
36             Setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, sizeof(on));

37             sock_set_port(ifi-&gt;ifi_brdaddr, salen, port);
38             if (bind(sockfd, ifi-&gt;ifi_brdaddr, salen) &lt; 0) {
39                 if (errno == EADDRINUSE) {
40                     printf("EADDRINUSE: %s\n",
41                            Sock_ntop(ifi-&gt;ifi_brdaddr, salen));
42                     Close(sockfd);
43                     continue;
44                 } else
45                     err_sys("bind error for %s",
46                             Sock_ntop(ifi-&gt;ifi_brdaddr, salen));
47             }
48             printf("bound %s\n", Sock_ntop(ifi-&gt;ifi_brdaddr, salen));

49             if ( (pid = Fork()) == 0) { /* child */
50                 mydg_echo(sockfd, ifi-&gt;ifi_brdaddr, salen);
51                 exit(0);        /* never executed */
52             }
53         }
54     }

55         /* bind wildcard address */
56     sockfd = Socket(family, SOCK_DGRAM, 0);
57     Setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, sizeof(on));

58     wild = Malloc(salen);
59     memcpy(wild, sa, salen);    /* copy family and port */
60     sock_set_wild(wild, salen);

61     Bind(sockfd, wild, salen);
62     printf("bound %s\n", Sock_ntop(wild, salen));

63     if ( (pid = Fork()) == 0) {  /* child */
64         mydg_echo(sockfd, wild, salen);
65         exit(0);                /* never executed */
66     }
67     exit(0);
68 }
69 void
70 mydg_echo(int sockfd, SA *myaddr, socklen_t salen)
71 {
72     int     n;
73     char    mesg[MAXLINE];
74     socklen_t len;
75     struct sockaddr *cli;

76     cli = Malloc(salen);

77     for ( ; ; ) {
78         len = salen;
79         n = Recvfrom(sockfd, mesg, MAXLINE, 0, cli, &amp;len);
80         printf("child %d, datagram from %s", getpid(), Sock_ntop(cli, len));
81         printf(", to %s\n", Sock_ntop(myaddr, salen));

82         Sendto(sockfd, mesg, n, 0, cli, len);
83     }
84 }
</PRE>
</TD></TR><TR valign="top"><TD align="right" class="docText"><B></B></TD><TD><P class="docText"></P></TD></TR></TABLE></P><br>
<P class="docText"></P>

<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_app05lev1sec20.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_app05lev1sec22.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
