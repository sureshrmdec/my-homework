<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="15.5 Unix Domain Stream Client/Server"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch15lev1sec4.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch15lev1sec6.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch15lev1sec5"></A>
<H3 class="docSection1Title">15.5 Unix Domain Stream Client/Server</H3>
<P class="docText">We now recode our TCP echo client/server from <A class="docLink" HREF="0131411551_ch05.html#ch05">Chapter 5</A> to use Unix domain sockets. <A class="docLink" HREF="#ch15fig03">Figure 15.3</A> shows the server, which is a modification of <A class="docLink" HREF="0131411551_ch05lev1sec10.html#ch05fig12">Figure 5.12</A> to use the Unix domain stream protocol instead of TCP.</P>
<p class="docText"><span class="docEmphasis"><TT>8</TT></span> The datatype of the two socket address structures is now <TT>sockaddr_un</TT>.</p>
<p class="docText"><span class="docEmphasis"><TT>10</TT></span> The first argument to <TT>socket</TT> is <TT>AF_LOCAL</TT>, to create a Unix domain stream socket.</p>
<p class="docText"><span class="docEmphasis"><TT>11–15</TT></span> The constant <TT>UNIXSTR_PATH</TT> is defined in <TT>unp.h</TT> to be <TT>/tmp/unix.str</TT>. We first <TT>unlink</TT> the pathname, in case it exists from an earlier run of the server, and then initialize the socket address structure before calling <TT>bind</TT>. An error from <TT>unlink</TT> is acceptable.</p>
<P class="docText">Notice that this call to <TT>bind</TT> differs from the call in <A class="docLink" HREF="0131411551_ch15lev1sec2.html#ch15fig02">Figure 15.2</A>. Here, we specify the size of the socket address structure (the third argument) as the total size of the <TT>sockaddr_un</TT> structure, not just the number of bytes occupied by the pathname. Both lengths are valid since the pathname must be null-terminated.</P>
<P class="docText">The remainder of the function is the same as <A class="docLink" HREF="0131411551_ch05lev1sec10.html#ch05fig12">Figure 5.12</A>. The same <TT>str_echo</TT> function is used (<A class="docLink" HREF="0131411551_ch05lev1sec4.html#ch05fig03">Figure 5.3</A>).</P>
<P class="docText"><A class="docLink" HREF="0131411551_ch15lev1sec6.html#ch15fig04">Figure 15.4</A> is the Unix domain stream protocol echo client. It is a modification of <A class="docLink" HREF="0131411551_ch05lev1sec4.html#ch05fig04">Figure 5.4</A>.</P>
<p class="docText"><span class="docEmphasis"><TT>6</TT></span> The socket address structure to contain the server's address is now a <TT>sockaddr_un</TT> structure.</p>
<p class="docText"><span class="docEmphasis"><TT>7</TT></span> The first argument to <TT>socket</TT> is <TT>AF_LOCAL</TT>.</p>
<p class="docText"><span class="docEmphasis"><TT>8–10</TT></span> The code to fill in the socket address structure is identical to the code shown for the server: Initialize the structure to 0, set the family to <TT>AF_LOCAL</TT>, and copy the pathname into the <TT>sun_path</TT> member.</p>
<p class="docText"><span class="docEmphasis"><TT>12</TT></span> The function <TT>str_cli</TT> is the same as earlier (<A class="docLink" HREF="0131411551_ch06lev1sec7.html#ch06fig13">Figure 6.13</A> was the last version we developed).</p>

<H5 class="docExampleTitle"><A NAME="ch15fig03"></A>Figure 15.3 Unix domain stream protocol echo server.</H5>
<P class="docText"><span class="docEmphasis">unixdomain/unixstrserv01.c</span></P>

<PRE>
 1 #include    "unp.h"

 2 int
 3 main(int argc, char **argv)
 4 {
 5     int     listenfd, connfd;
 6     pid_t   childpid;
 7     socklen_t clilen;
 8     struct sockaddr_un cliaddr, servaddr;
 9     void    sig_chld(int);

10     listenfd = Socket(AF_LOCAL, SOCK_STREAM, 0);

11     unlink(UNIXSTR_PATH);
12     bzero(&amp;servaddr, sizeof(servaddr));
13     servaddr.sun_family = AF_LOCAL;
14     strcpy(servaddr.sun_path, UNIXSTR_PATH);

15     Bind(listenfd, (SA *) &amp;servaddr, sizeof(servaddr));

16     Listen(listenfd, LISTENQ);

17     Signal(SIGCHLD, sig_chld);

18     for ( ; ; ) {
19         clilen = sizeof(cliaddr);
20         if ( (connfd = accept(listenfd, (SA *) &amp;cliaddr, &amp;clilen)) &lt; 0) {
21             if (errno == EINTR)
22                 continue;       /* back to for() */
23             else
24                 err_sys("accept error");
25         } 

26         if ( (childpid = Fork()) == 0) { /* child process */
27             Close(listenfd);    /* close listening socket */
28             str_echo(connfd);   /* process request */
29             exit(0);
30         }
31         Close(connfd);          /* parent closes connected socket */
32     } 
33 }
</PRE>


<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch15lev1sec4.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch15lev1sec6.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
