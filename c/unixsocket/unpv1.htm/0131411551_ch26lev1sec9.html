<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="26.9 Web Client and Simultaneous Connections (Continued)"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch26lev1sec8.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch26lev1sec10.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch26lev1sec9"></A>
<H3 class="docSection1Title">26.9 Web Client and Simultaneous Connections (Continued)</H3>
<P class="docText">We now recode our Web client from <A class="docLink" HREF="0131411551_ch26lev1sec6.html#ch26lev1sec6">Section 26.6</A>, removing the call to the Solaris <TT>thr_join</TT> function and replacing it with a call to <TT>pthread_join</TT>. As discussed in that section, we now must specify exactly which thread we are waiting for. To do this we will use a condition variable, as described in <A class="docLink" HREF="0131411551_ch26lev1sec8.html#ch26lev1sec8">Section 26.8</A></P>
<P class="docText">The only change to the globals (<A class="docLink" HREF="0131411551_ch26lev1sec6.html#ch26fig13">Figure 26.13</A>) is to add one new flag and the condition variable.</P>
<pre>

</pre><pre>
     #define   F_JOINED        8   /* main has pthread_join'ed */

     int              ndone;       /* number of terminated threads */
     pthread_mutex_t  ndone_mutex = PTHREAD_MUTEX_INITIALIZER;
     pthread_cond_t   ndone_cond  = PTHREAD_COND_INITIALIZER;
</pre><pre>
</pre>
<P class="docText">The only change to the <TT>do_get_read</TT> function (<A class="docLink" HREF="0131411551_ch26lev1sec6.html#ch26fig15">Figure 26.15</A>) is to increment <TT>ndone</TT> and signal the main loop before the thread terminates.</P>
<pre>

</pre><pre>
          printf("end-of-file on %s\n", fptr-&gt;f_name);
          Close(fd);

          Pthread_mutex_lock(&amp;ndone_mutex);
          fptr-&gt;f_flags = F_DONE;     /* clears F_READING */
          ndone++;
          Pthread_cond_signal(&amp;ndone_cond);
          Pthread_mutex_unlock(&amp;ndone_mutex);

          return(fptr);       /* terminate thread */
  }
</pre><pre>
</pre>
<P class="docText">Most changes are in the main loop, <A class="docLink" HREF="0131411551_ch26lev1sec6.html#ch26fig14">Figure 26.14</A>, the new version of which we show in <A class="docLink" HREF="#ch26fig19">Figure 26.19</A>.</P>

<H5 class="docExampleTitle"><A NAME="ch26fig19"></A>Figure 26.19 Main processing loop of <TT>main</TT> function.</H5>
<P class="docText"><span class="docEmphasis">threads/web03.c</span></P>

<PRE>
43     while (nlefttoread &gt; 0) {
44         while (nconn &lt; maxnconn &amp;&amp; nlefttoconn &gt; 0) {
45                 /* find a file to read */
46             for (i = 0; i &lt; nfiles; i++)
47                 if (file[i].f_flags == 0)
48                     break;
49             if (i == nfiles)
50                 err_quit("nlefttoconn = %d but nothing found", nlefttoconn);

51             file[i].f_flags = F_CONNECTING;
52             Pthread_create(&amp;tid, NULL, &amp;do_get_read, &amp;file[i]);
53             file[i].f_tid = tid;
54             nconn++;
55             nlefttoconn--;
56          }

57              /* Wait for thread to terminate */
58          Pthread_mutex_lock(&amp;ndone_mutex);
59          while (ndone == 0)
60              Pthread_cond_wait(&amp;ndone_cond, &amp;ndone_mutex);

61          for (i = 0; i &lt; nfiles; i++) {
62              if (file[i].f_flags &amp; F_DONE) {
63                  Pthread_join(file[i].f_tid, (void **) &amp;fptr);

64                  if (&amp;file[i] != fptr)
65                      err_quit("file[i]!= fptr");
66                  fptr-&gt;f_flags = F_JOINED;  /* clears F_DONE */
67                  ndone--;
68                  nconn--;
69                  nlefttoread--;
70                  printf("thread %d for %s done\n", fptr-&gt;f_tid, fptr-&gt;f_name);
71               }
72          }
73          Pthread_mutex_unlock(&amp;ndone_mutex);
74     }

75     exit(0);
76 }
</PRE>

<A NAME="ch26lev3sec21"></A>
<H4 class="docSection2Title"> If possible, create another thread</H4>
<p class="docText"><span class="docEmphasis"><TT>44–56</TT></span> This code has not changed.</p>

<A NAME="ch26lev3sec22"></A>
<H4 class="docSection2Title"> Wait for thread to terminate</H4>
<p class="docText"><span class="docEmphasis"><TT>57–60</TT></span> To wait for one of the threads to terminate, we wait for <TT>ndone</TT> to be nonzero. As discussed in <A class="docLink" HREF="0131411551_ch26lev1sec8.html#ch26lev1sec8">Section 26.8</A>, the test must be done while the mutex is locked. The sleep is performed by <TT>pthread_cond_wait</TT>.</p>

<A NAME="ch26lev3sec23"></A>
<H4 class="docSection2Title"> Handle terminated thread</H4>
<p class="docText"><span class="docEmphasis"><TT>61–73</TT></span> When a thread has terminated, we go through all the <TT>file</TT> structures to find the appropriate thread, call <TT>pthread_join</TT>, and then set the new <TT>F_JOINED</TT> flag.</p>
<P class="docText"><A class="docLink" HREF="0131411551_ch16lev1sec5.html#ch16fig20">Figure 16.20</A> shows the timing for this version, along with the timing of the version using nonblocking <TT>connect</TT>s.</P>


<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch26lev1sec8.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch26lev1sec10.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
