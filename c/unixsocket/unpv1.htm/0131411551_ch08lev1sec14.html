<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="8.14 Determining Outgoing Interface with UDP"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch08lev1sec13.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch08lev1sec15.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch08lev1sec14"></A>
<H3 class="docSection1Title" id="225793-958">8.14 Determining Outgoing Interface with UDP</H3>
<P class="docText">A connected UDP socket can also be used to determine the outgoing interface that will be used to a particular destination. This is because of a side effect of the <TT>connect</TT> function when applied to a UDP socket: The kernel chooses the local IP address (assuming the process has not already called <TT>bind</TT> to explicitly assign this). This local IP address is chosen by searching the routing table for the destination IP address, and then using the primary IP address for the resulting interface.</P>
<P class="docText"><A class="docLink" HREF="#ch08fig23">Figure 8.23</A> shows a simple UDP program that <TT>connects</TT> to a specified IP address and then calls <TT>getsockname</TT>, printing the local IP address and port.</P>

<H5 class="docExampleTitle"><A NAME="ch08fig23"></A>Figure 8.23 UDP program that uses <TT>connect</TT> to determine outgoing interface.</H5>
<P class="docText"><span class="docEmphasis">udpcliserv/udpcli09.c</span></P>

<PRE>
 1 #include     "unp.h"

 2 int
 3 main(int argc, char **argv)
 4 {
 5     int     sockfd;
 6     socklen_t len;
 7     struct sockaddr_in cliaddr, servaddr;

 8     if (argc != 2)
 9         err_quit("usage: udpcli &lt;IPaddress&gt;");

10     sockfd = Socket(AF_INET, SOCK_DGRAM, 0);

11     bzero(&amp;servaddr, sizeof(servaddr));
12     servaddr.sin_family = AF_INET;
13     servaddr.sin_port = htons(SERV_PORT);
14     Inet_pton(AF_INET, argv[1], &amp;servaddr.sin_addr);

15     Connect(sockfd, (SA *) &amp;servaddr, sizeof(servaddr));

16     len = sizeof(cliaddr);
17     Getsockname(sockfd, (SA *) &amp;cliaddr, &amp;len);
18     printf("local address %s\n", Sock_ntop((SA *) &amp;cliaddr, len));

19     exit(0);
20 }
</PRE>

<P class="docText">If we run the program on the multihomed host <TT>freebsd</TT>, we have the following output:</P>
<pre>

</pre><pre>
freebsd % <span class="docEmphStrong">udpcli09 206.168.112.96</span>
local address 12.106.32.254:52329

freebsd % <span class="docEmphStrong">udpcli09 192.168.42.2</span>
local address 192.168.42.1:52330

freebsd % <span class="docEmphStrong">udpcli09 127.0.0.1</span>
local address 127.0.0.1:52331
</pre><pre>
</pre>
<P class="docText">The first time we run the program, the command-line argument is an IP address that follows the default route. The kernel assigns the local IP address to the primary address of the interface to which the default route points. The second time, the argument is the IP address of a system connected to a second Ethernet interface, so the kernel assigns the local IP address to the primary address of this second interface. Calling <TT>connect</TT> on a UDP socket does not send anything to that host; it is entirely a local operation that saves the peer's IP address and port. We also see that calling <TT>connect</TT> on an unbound UDP socket also assigns an ephemeral port to the socket.</P>
<BLOCKQUOTE><P><P class="docList">Unfortunately, this technique does not work on all implementations, mostly SVR4-derived kernels. For example, this does not work on Solaris 2.5, but it works on AIX, HP-UX 11, MacOS X, FreeBSD, Linux, and Solaris 2.6 and later.</P></P></BLOCKQUOTE>

<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch08lev1sec13.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch08lev1sec15.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
