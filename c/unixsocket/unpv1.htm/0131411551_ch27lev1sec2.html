<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="27.2 IPv4 Options"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch27lev1sec1.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch27lev1sec3.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch27lev1sec2"></A>
<H3 class="docSection1Title">27.2 IPv4 Options</H3>
<P class="docText">In <A class="docLink" HREF="0131411551_app01lev1sec2.html#app01fig01">Figure A.1</A>, we show options following the 20-byte IPv4 header. As noted there, the 4-bit header length field limits the total size of the IPv4 header to 15 32-bit words (60 bytes), so the size of the IP options is limited to 40 bytes. Ten different options are defined for IPv4:</P>
<span style="font-weight:bold"><OL class="docList" TYPE="1"><LI><span style="font-weight:normal"><P class="docList">NOP: no-operation—A one-byte option typically used for padding to make a later option fall on a four-byte boundary.</P></span></LI><LI><span style="font-weight:normal"><P class="docList">EOL: end-of-list—A one-byte option that terminates option processing. Since the total size of the IP options must be a multiple of four bytes, EOL bytes follow the final option.</P></span></LI><LI><span style="font-weight:normal"><P class="docList">LSRR: loose source and record route (Section 8.5 of TCPv1)—We will show an example of this shortly.</P></span></LI><LI><span style="font-weight:normal"><P class="docList">SSRR: strict source and record route (Section 8.5 of TCPv1)—We will show an example of this shortly.</P></span></LI><LI><span style="font-weight:normal"><P class="docList">Timestamp (Section 7.4 of TCPv1).</P></span></LI><LI><span style="font-weight:normal"><P class="docList">Record route (Section 7.3 of TCPv1).</P></span></LI><LI><span style="font-weight:normal"><P class="docList">Basic security (obsolete).</P></span></LI><LI><span style="font-weight:normal"><P class="docList">Extended security (obsolete).</P></span></LI><LI><span style="font-weight:normal"><P class="docList">Stream identifier (obsolete).</P></span></LI><LI><span style="font-weight:normal"><P class="docList">Router alert—This option is described in RFC 2113 [Katz 1997]. This option is included in IP datagrams that should be examined by all routers that forward the datagram.</P></span></LI></OL></span>
<P class="docText">Chapter 9 of TCPv2 provides further details on the kernel processing of the first six options, and the indicated sections in TCPv1 provide examples of their use.</P>
<P class="docText">The <TT>getsockopt</TT> and <TT>setsockopt</TT> functions (with a <span class="docEmphasis">level</span> of <TT>IPPROTO_IP</TT> and an <span class="docEmphasis">optname</span> of <TT>IP_OPTIONS</TT>) fetch and set the IP options. The fourth argument to <TT>getsockopt</TT> and <TT>setsockopt</TT> is a pointer to a buffer (whose size is 44 bytes or less), and the fifth argument is the size of this buffer. The reason that the size of this buffer for <TT>getsockopt</TT> can be four bytes larger than the maximum size of the options is because of the way the source route option is handled, as we will describe shortly. Other than the two source route options, the format of what goes into the buffer is the format of the options when placed into the IP datagram.</P>
<P class="docText">When the IP options are set using <TT>setsockopt</TT>, the specified options will then be sent on all IP datagrams on that socket. This works for TCP, UDP, and raw IP sockets. To clear these options, call <TT>setsockopt</TT> and specify either a null pointer as the fourth argument or a value of 0 as the fifth argument (the length).</P>
<BLOCKQUOTE><P><P class="docList">Setting the IP options for a raw IP socket does not work on all implementations if the <TT>IP_HDRINCL</TT> socket option (which we will describe in the next chapter) is also set. Many Berkeley-derived implementations do not send the options set with <TT>IP_OPTIONS</TT> when <TT>IP_HDRINCL</TT> is enabled, because the application can set its own IP options in the IP header it builds (pp. 1056–1057 of TCPv2). Other systems (e.g., FreeBSD) allow the application to specify IP options using either the <TT>IP_OPTIONS</TT> socket option or by setting <TT>IP_HDRINCL</TT> and including them in the IP header that it builds, but not both.</P></P></BLOCKQUOTE>
<P class="docText">When <TT>getsockopt</TT> is called to fetch the IP options for a connected TCP socket that was created by <TT>accept</TT>, all that is returned is the reversal of the source route option received with the client's SYN for the listening socket (p. 931 of TCPv2). The source route is automatically reversed by TCP because the source route specified by the client was from the client to the server, but the server needs to use the reverse of this route in datagrams it sends to the client. If no source route accompanied the SYN, then the value-result length returned by <TT>getsockopt</TT> through its fifth argument will be 0. For all other TCP sockets and for all UDP sockets and raw IP sockets, calling <TT>getsockopt</TT> to fetch the IP options just returns a copy of whatever IP options have been set by <TT>setsockopt</TT> for the socket. Note that for a raw IP socket, the received IP header, including any IP options, is always returned by the input functions, so the received IP options are always available.</P>
<BLOCKQUOTE><P><P class="docList">Berkeley-derived kernels have never returned a received source route, or any other IP options, for a UDP socket. The code shown on p. 775 of TCPv2 to return the IP options has existed since 4.3BSD Reno, but has always been commented out since it does not work. This makes it impossible for a UDP application to use the reverse of a received route for datagrams back to the sender.</P></P></BLOCKQUOTE>

<a href="0131411551_23961534.html"><img src="FILES/pixel.gif" width="1" height="1" border="0"></a><ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch27lev1sec1.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch27lev1sec3.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
