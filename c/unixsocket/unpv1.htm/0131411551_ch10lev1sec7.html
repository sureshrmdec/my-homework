<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="10.7 Controlling Termination"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_ch10lev1sec6.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_ch10lev1sec8.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="ch10lev1sec7"></A>
<H3 class="docSection1Title">10.7 Controlling Termination</H3>
<P class="docText">In our examples, we have depended on the client closing the socket to shut down the association. But the client application may not always wish to close the socket. For that matter, our server may not want to keep the association open after sending the reply message. In these cases, we need to look at two alternative mechanisms for shutting down an association. For the one-to-many-style interface, two possible methods are available to the application: one is graceful, while the other is disruptive.</P>
<P class="docText">If a server wishes to shut down an association after sending a message, we apply the <TT>MSG_EOF</TT> flag to the reply message in the <TT>sinfo_flags</TT> field of the <TT>sctp_sndrcvinfo</TT> structure. This flag forces an association to shut down after the message being sent is acknowledged. The other alternative is to apply the <TT>MSG_ABORT</TT> flag to the <TT>sinfo_flags</TT> field. This flag will force an immediate termination of the association with an ABORT chunk. An ABORT chunk is similar to a TCP RST segment, terminating any association without delay. Note that any data not yet transfered will be discarded. However, closing an SCTP session with an ABORT chunk does not have any negative side effects like preventing TCP's TIME_WAIT state; the ABORT chunk causes a "graceful" abortive close. <A class="docLink" HREF="#ch10fig11">Figure 10.11</A> shows the modifications needed to our echo server to initiate a graceful shutdown when the response message is sent to the peer. <A class="docLink" HREF="#ch10fig12">Figure 10.12</A> shows a modified client that sends an ABORT chunk before closing the socket.</P>

<H5 class="docExampleTitle"><A NAME="ch10fig11"></A>Figure 10.11 The server terminates an association on reply.</H5>
<P class="docText"><span class="docEmphasis">sctp/sctpserv03.c</span></P>

<PRE>
25     for ( ; ; ) {
26         len = sizeof(struct sockaddr_in);
27         rd_sz = Sctp_recvmsg(sock_fd, readbuf, sizeof (readbuf),
28                              (SA *) &amp;cliaddr, &amp;len, &amp;sri, &amp;msg_flags);
29         if (stream_increment) {
30             sri.sinfo_stream++;
31             if (sri.sinfo_stream &gt;=
32                 sctp_get_no_strms (sock_fd, (SA *) &amp;cliaddr, len))
33                 sri.sinfo_stream = 0;
34         }
35         Sctp_sendmsg (sock_fd, readbuf, rd_sz,
36                       (SA *) &amp;cliaddr, len,
37                       sri.sinfo_ppid,
38                       (sri.sinfo_flags | MSG_EOF), sri.sinfo_stream, 0, 0);
</PRE>

<A NAME="ch10lev3sec29"></A>
<H4 class="docSection2Title"> Send back response, but shut down association</H4>
<p class="docText"><span class="docEmphasis"><TT>38</TT></span> We can see that the change in this line is simply OR'ing the <TT>MSG_EOF</TT> flag to the <TT>sctp_sendmsg</TT> function. This flag value causes our server to shut down the association after the reply message is successfully acknowledged.</p>

<H5 class="docExampleTitle"><A NAME="ch10fig12"></A>Figure 10.12 The client aborts the association before closing.</H5>
<P class="docText"><span class="docEmphasis">sctp/sctpclient02.c</span></P>

<PRE>
25     if (echo_to_all == 0)
26         sctpstr_cli(stdin, sock_fd, (SA *) &amp;servaddr, sizeof (servaddr));
27     else
28         sctpstr_cli_echoall(stdin, sock_fd, (SA *) &amp;servaddr,
29                             sizeof (servaddr));
30     strcpy(byemsg, "goodbye");
31     Sctp_sendmsg(sock_fd, byemsg, strlen (byemsg),
32                  (SA *) &amp;servaddr, sizeof (servaddr), 0, MSG_ABORT, 0, 0, 0);
33     Close(sock_fd);
</PRE>


<A NAME="ch10lev3sec30"></A>
<H4 class="docSection2Title"> Abort association before close</H4>
<p class="docText"><span class="docEmphasis"><TT>30–32</TT></span> In these lines, the client prepares a message that is included with the abort as a user error cause. The client then calls the <TT>sctp_sendmsg</TT> function with the <TT>MSG_ABORT</TT> flag. This flag sends an ABORT chunk, which immediately terminates the association. The ABORT chunk includes the user-initiated error cause with the message ("goodbye") in the upper layer reason field.</p>

<A NAME="ch10lev3sec31"></A>
<H4 class="docSection2Title"> Close socket descriptor</H4>
<p class="docText"><span class="docEmphasis"><TT>33</TT></span> Even though the association has been aborted, we still need to close the socket descriptor to free the system resources associated with it.</p>


<a href="0131411551_22961534.html"><img src="FILES/pixel.gif" width="1" height="1" border="0"></a><ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_ch10lev1sec6.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_ch10lev1sec8.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
