<html><head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<!--SafClassName="docSection1Title"--><!--SafTocEntry="D.3 Standard Error Functions"-->
<link rel="STYLESHEET" type="text/css" href="FILES/style.css">
<link rel="STYLESHEET" type="text/css" href="FILES/docsafari.css">
<style type="text/css">	.tt1    {font-size: 10pt;}</style>
</head>
<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
	<a href="0131411551_app04lev1sec2.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
	<a href="0131411551_app05.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><A NAME="app04lev1sec3"></A>
<H3 class="docSection1Title" id="162666-841">D.3 Standard Error Functions</H3>
<P class="docText">We define our own set of error functions that are used throughout the text to handle error conditions. The reason for using our own error functions is to let us write our error handling with a single line of C code, as in</P>
<pre>

</pre><pre>
if <span class="docEmphasis">(error condition)</span>
    err_sys <span class="docEmphasis">(printf format with any number of arguments)</span>;
</pre><pre>
</pre>
<P class="docText">instead of</P>
<pre>

</pre><pre>
if <span class="docEmphasis">(error condition)</span> {
    char buff [2002];
    snprintf(buff, sizeof (buff), <span class="docEmphasis">printf format with any number of arguments)</span>;
    perror(buff);
    exit (1);
}
</pre><pre>
</pre>
<P class="docText">Our error functions use the variable-length argument list facility from <TT>ANSI C</TT>. See Section 7.3 of [Kernighan and Ritchie 1988] for additional details.</P>
<P class="docText"><A class="docLink" HREF="#app04fig03">Figure D.3</A> lists the differences between the various error functions. If the global integer <TT>daemon_proc</TT> is nonzero, the message is passed to <TT>syslog</TT> with the indicated level; otherwise, the error is output to standard error.</P>
<CENTER>
<H5 class="docFigureTitle"><A NAME="app04fig03"></A>Figure D.3. Summary of our standard error functions.</H5>

<p class="docText">
<IMG BORDER="0" id="132235130214" WIDTH="367" HEIGHT="138" src="FILES/xdfig03.gif" ALT="graphics/xdfig03.gif"></p>

</CENTER>
<P class="docText"><A class="docLink" HREF="#app04fig04">Figure D.4</A> shows the first five functions from <A class="docLink" HREF="#app04fig03">Figure D.3</A>.</P>

<H5 class="docExampleTitle"><A NAME="app04fig04"></A>Figure D.4 Our standard error functions.</H5>
<P class="docText"><span class="docEmphasis">lib/error.c</span></P>

<PRE>
 1 #include    "unp.h"
 2 #include    &lt;stdarg.h&gt;          /* ANSI C header file */
 3 #include    &lt;syslog.h&gt;          /* for syslog() */

 4 int     daemon_proc;            /* set nonzero by daemon_init() */

 5 static void err_doit(int, int, const char *, va_list);

 6 /* Nonfatal error related to system call
 7  * Print message and return */

 8 void
 9 err_ret(const char *fmt, ...)
10 {
11     va_list ap;

12     va_start(ap, fmt);
13     err_doit(1, LOG_INFO, fmt, ap);
14     va_end(ap);
15     return;
16 }

17 /* Fatal error related to system call
18  * Print message and terminate */

19 void
20 err_sys(const char *fmt, ...)
21 {
22     va_list ap;

23     va_start(ap, fmt);
24     err_doit(1, LOG_ERR, fmt, ap);
25     va_end(ap);
26     exit(1);
27 }

28 /* Fatal error related to system call
29  * Print message, dump core, and terminate */

30 void
31 err_dump(const char *fmt, ...)
32 {
33     va_list ap;

34     va_start(ap, fmt);
35     err_doit(1, LOG_ERR, fmt, ap);
36     va_end(ap);
37     abort();                    /* dump core and terminate */
38     exit(1);                    /* shouldn't get here */
39 }

40 /* Nonfatal error unrelated to system call
41  * Print message and return */

42 void
43 err_msg(const char *fmt, ...)
44 {
45     va_list ap;

46     va_start(ap, fmt);
47     err_doit(0, LOG_INFO, fmt, ap);
48     va_end(ap);
49     return;
50 }

51 /* Fatal error unrelated to system call
52  * Print message and terminate */

53 void
54 err_quit(const char *fmt, ...)
55 {
56     va_list ap;

57     va_start(ap, fmt);
58     err_doit(0, LOG_ERR, fmt, ap);

59     va_end(ap);
60     exit(1);
61 }

62 /* Print message and return to caller
63  * Caller specifies "errnoflag" and "level" */

64 static void
65 err_doit(int errnoflag, int level, const char *fmt, va_list ap)
66 {
67     int     errno_save, n;
68     char    buf[MAXLINE + 1];

69     errno_save = errno;         /* value caller might want printed */
70 #ifdef HAVE_VSNPRINTF
71     vsnprintf(buf, MAXLINE, fmt, ap);   * safe */
72 #else
73     vsprintf(buf, fmt, ap);     /* not safe */
74 #endif
75     n = strlen(buf);
76     if (errnoflag)
77         snprintf(buf + n, MAXLINE - n, ": %s", strerror(errno_save));
78     strcat(buf, "\n");

79     if (daemon_proc) {
80         syslog(level, buf);
81     } else {
82         fflush(stdout);         /* in case stdout and stderr are the same */
83         fputs(buf, stderr);
84         fflush(stderr);
85     }
86     return;
87 }
</PRE>


<ul></ul></td></tr></table>
<td></td>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<td class="tt1"><a href="NFO/lib.html">[ Team LiB ]</a></td><td valign="top" class="tt1" align="right">
          <a href="0131411551_app04lev1sec2.html"><img src="FILES/btn_prev.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
          <a href="0131411551_app05.html"><img src="FILES/btn_next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a>
</td></table>
</body></html>
